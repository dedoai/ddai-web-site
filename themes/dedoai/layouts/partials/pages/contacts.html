{{- $_ := .Page.Params -}}
<div class="container">
  <div class="section-title">
    <h1>
      {{$_.title}}
      <span class="span-title">{{$_.spanTitle}}</span>
    </h1>
    <p>{{$_.p1}}</p>
  </div>

  <div class="main">
    <div class="frm-hldr">
      <h2>
        {{$_.subt}}
        <span class="span-title">{{$_.spanSubtitle}}</span>
      </h2>
      <p>{{$_.p2 | markdownify}}</p>
      <form id="ctcfrm">
        {{range $_.form.items}}
        <div class="item">
          <label for="{{.name}}">{{.label}}</label>
          {{ if ne .type "textarea"}}
          {{if ne .type "select"}}
          <div class="input-icon">
            <img src="{{.icon}}">
            <input type="{{.type}}" id="{{.name}}" name="{{.name}}" placeholder="{{.placeholder}}" required>
          </div>
          {{else}}
          <select id="{{.name}}" name="{{.name}}" required>
            <option disabled selected hidden value="">{{.placeholder}}</option>
            {{range .options}}
            <option value="{{.value}}">{{.label}}</option>
            {{end}}
          </select>
          {{end}}
          {{else}}
          <textarea id="{{.name}}" name="{{.name}}" placeholder="{{.placeholder}}" required></textarea>
          {{end}}
        </div>
        {{end}}

        <button id="submit-btn" type="submit" class="btn btn-cta">{{$_.form.submit_text}}</button>
        <div id="subresp"></div>
      </form>
    </div>
  </div>
</div>
<script>
  document
    .addEventListener('DOMContentLoaded', function () {
      document
        .querySelector('#ctcfrm')
        .addEventListener('submit', function (e) {

          e.preventDefault();

          const data = Object.fromEntries(new FormData(this).entries());

          const captchaAction = 'CONTACT_REQUEST';

          grecaptcha
            .enterprise
            .ready(async () => {

              const token = await grecaptcha.enterprise.execute(recaptchaKey, { action: captchaAction });

              data.recaptchaToken = token;
              data.recaptchaAction = captchaAction;

              fetch("{{$_.form.action}}", {
                method: 'POST',
                body: JSON.stringify(data)
              })
                .then((response) => {
                  let toRet = {};

                  if (response.status === 200) toRet = response.json();

                  return toRet;
                })
                .then((response) => {
                  const body = JSON.parse(response.body);
                  const statusBox = document.getElementById('subresp');
                  const submitBtn = document.getElementById('submit-btn');
                  submitBtn.classList.add('hidden');
                  statusBox.innerHTML = '<span>' + body.message + '</span>';
                  e.target.reset()
                })
            });
        });
    });
</script>
